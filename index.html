<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FRED POC — 30-Year Mortgage Rate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;1,300&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --ink: #1a1612;
      --paper: #f5f0e8;
      --accent: #c94f2a;
      --muted: #8a7f72;
      --rule: #d9d0c0;
    }
    body {
      background: var(--paper);
      color: var(--ink);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
      padding: 3rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .page { width: 100%; max-width: 900px; }
    .header {
      border-top: 3px solid var(--ink);
      border-bottom: 1px solid var(--rule);
      padding: 1.5rem 0 1rem;
      margin-bottom: 2.5rem;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: end;
      gap: 1rem;
    }
    .eyebrow {
      font-size: 0.65rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 0.4rem;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.8rem, 4vw, 2.8rem);
      font-weight: 700;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .header-meta {
      text-align: right;
      font-size: 0.65rem;
      color: var(--muted);
      line-height: 1.8;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--rule);
      border: 1px solid var(--rule);
      margin-bottom: 2.5rem;
    }
    .stat {
      background: var(--paper);
      padding: 1.25rem 1.5rem;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .stat.visible { opacity: 1; transform: translateY(0); }
    .stat:nth-child(2) { transition-delay: 0.1s; }
    .stat:nth-child(3) { transition-delay: 0.2s; }
    .stat-label {
      font-size: 0.6rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.4rem;
    }
    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-value.up { color: var(--accent); }
    .stat-value.down { color: #2a7a4f; }
    .stat-sub { font-size: 0.62rem; color: var(--muted); margin-top: 0.3rem; font-style: italic; }
    .chart-wrap {
      position: relative;
      background: var(--paper);
      border: 1px solid var(--rule);
      padding: 2rem 2rem 1.5rem;
      margin-bottom: 1rem;
    }
    .chart-title {
      font-size: 0.6rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 1.5rem;
    }
    canvas { max-height: 340px; }
    .state {
      text-align: center;
      padding: 4rem 2rem;
      font-size: 0.75rem;
      color: var(--muted);
      letter-spacing: 0.08em;
    }
    .state.error { color: var(--accent); }
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--rule);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.75rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .footer {
      border-top: 1px solid var(--rule);
      padding-top: 1rem;
      font-size: 0.6rem;
      color: var(--muted);
      letter-spacing: 0.08em;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <div>
      <div class="eyebrow">Federal Reserve Economic Data</div>
      <h1>30-Year Fixed<br>Mortgage Rate</h1>
    </div>
    <div class="header-meta" id="header-meta">
      Loading data…<br>
      Series: MORTGAGE30US
    </div>
  </header>

  <div class="stats" id="stats" style="display:none">
    <div class="stat">
      <div class="stat-label">Current Rate</div>
      <div class="stat-value" id="val-current">—</div>
      <div class="stat-sub">Latest weekly reading</div>
    </div>
    <div class="stat">
      <div class="stat-label">Week-over-week</div>
      <div class="stat-value" id="val-delta">—</div>
      <div class="stat-sub">Change from prior week</div>
    </div>
    <div class="stat">
      <div class="stat-label">52-week range</div>
      <div class="stat-value" id="val-range">—</div>
      <div class="stat-sub">Low to High</div>
    </div>
  </div>

  <div class="chart-wrap" id="chart-wrap" style="display:none">
    <div class="chart-title">Weekly average, percent — 5-year history</div>
    <canvas id="chart"></canvas>
  </div>

  <div id="state-msg" class="state">
    <span class="loader"></span> Fetching from FRED…
  </div>

  <footer class="footer">
    <span>Source: Federal Reserve Bank of St. Louis</span>
    <span id="footer-date"></span>
  </footer>
</div>

<script>
  const API_KEY = '';  // key is handled server-side
  const SERIES  = 'MORTGAGE30US';

  const today      = new Date();
  const fiveYrsAgo = new Date(today);
  fiveYrsAgo.setFullYear(today.getFullYear() - 5);
  const fmt = d => d.toISOString().split('T')[0];

  const url = '/.netlify/functions/fred-proxy'
    + '?series_id=' + SERIES

    + '&file_type=json'
    + '&observation_start=' + fmt(fiveYrsAgo)
    + '&observation_end=' + fmt(today)
    + '&sort_order=asc';

  async function init() {
    try {
      const res  = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();

      const obs = json.observations
        .filter(function(o) { return o.value !== '.'; })
        .map(function(o) { return { date: o.date, value: parseFloat(o.value) }; });

      if (!obs.length) throw new Error('No observations returned');

      renderStats(obs);
      renderChart(obs);

      document.getElementById('state-msg').style.display = 'none';
      document.getElementById('stats').style.display = 'grid';
      document.getElementById('chart-wrap').style.display = 'block';

      setTimeout(function() {
        document.querySelectorAll('.stat').forEach(function(el) { el.classList.add('visible'); });
      }, 60);

      var last = obs[obs.length - 1];
      document.getElementById('header-meta').innerHTML = 'As of ' + last.date + '<br>Series: ' + SERIES;
      document.getElementById('footer-date').textContent = 'Retrieved ' + fmt(today);

    } catch(err) {
      var msg = document.getElementById('state-msg');
      msg.className = 'state error';
      msg.innerHTML = 'Could not load data: ' + err.message;
      console.error(err);
    }
  }

  function renderStats(obs) {
    var current  = obs[obs.length - 1].value;
    var previous = obs[obs.length - 2].value;
    var delta    = current - previous;

    var cutoff = new Date(today);
    cutoff.setFullYear(today.getFullYear() - 1);
    var year   = obs.filter(function(o) { return new Date(o.date) >= cutoff; });
    var values = year.map(function(o) { return o.value; });
    var low    = Math.min.apply(null, values);
    var high   = Math.max.apply(null, values);

    document.getElementById('val-current').textContent = current.toFixed(2) + '%';

    var dEl = document.getElementById('val-delta');
    dEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(2) + '%';
    dEl.className = 'stat-value ' + (delta > 0 ? 'up' : delta < 0 ? 'down' : '');

    document.getElementById('val-range').textContent = low.toFixed(2) + ' - ' + high.toFixed(2);
  }

  function renderChart(obs) {
    var labels = obs.map(function(o) { return o.date; });
    var values = obs.map(function(o) { return o.value; });

    var ctx  = document.getElementById('chart').getContext('2d');
    var grad = ctx.createLinearGradient(0, 0, 0, 340);
    grad.addColorStop(0, 'rgba(201, 79, 42, 0.18)');
    grad.addColorStop(1, 'rgba(201, 79, 42, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          borderColor: '#c94f2a',
          borderWidth: 1.5,
          backgroundColor: grad,
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#c94f2a',
          pointHoverBorderColor: '#f5f0e8',
          pointHoverBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1a1612',
            titleColor: '#8a7f72',
            bodyColor: '#f5f0e8',
            titleFont: { family: 'DM Mono', size: 10 },
            bodyFont: { family: 'Playfair Display', size: 16 },
            padding: 12,
            displayColors: false,
            callbacks: {
              title: function(items) { return items[0].label; },
              label: function(item)  { return item.raw.toFixed(2) + '%'; }
            }
          }
        },
        scales: {
          x: {
            grid: { color: '#e8e0d0', drawTicks: false },
            border: { color: '#d9d0c0' },
            ticks: { color: '#8a7f72', font: { family: 'DM Mono', size: 9 }, maxTicksLimit: 8, maxRotation: 0 }
          },
          y: {
            position: 'right',
            grid: { color: '#e8e0d0', drawTicks: false },
            border: { color: 'transparent' },
            ticks: {
              color: '#8a7f72',
              font: { family: 'DM Mono', size: 9 },
              callback: function(v) { return v.toFixed(1) + '%'; }
            }
          }
        }
      }
    });
  }

  init();
</script>
</body>
</html>
